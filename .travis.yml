language: cpp
sudo: false

addons:
  apt:
    sources:
      - sourceline: 'ppa:george-edison55/cmake-3.x'
      - ubuntu-toolchain-r-test
#      - george-edison55-cmake-3.x
#      - llvm-toolchain-precise-3.7
    packages:
      - build-essential
      - gawk
      - ccache
      - genromfs
      - libc6-i386
      - libxml2-dev
      - libxslt1-dev
      - python-pip
      - python-dev
      - zlib1g-dev
      - gcc-4.9
      - g++-4.9
      - cmake
      - cmake-data
#      - clang-3.7
#      - llvm-3.7

cache:
  ccache: true
  directories:
    - $HOME/opt

before_install:
  - Tools/scripts/configure-ci.sh

script:
  - Tools/scripts/mttr-build-ci.sh

before_cache:
  - ccache -z

compiler:
  - gcc
#  - clang

env:
  global:
    # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
    #   via the "travis encrypt" command using the project repo's public key
    - secure: "FjIwqZQV2FhNPWYITX5LZXTE38yYqBaQdbm3QmbEg/30wnPTm1ZOLIU7o/aSvX615ImR8kHoryvFPDQDWc6wWfqTEs3Ytq2kIvcIJS2Y5l/0PFfpWJoH5gRd6hDThnoi+1oVMLvj1+bhn4yFlCCQ2vT/jxoGfiQqqgvHtv4fLzI="

matrix:
  fast_finish: true
  include:
    - compiler: "gcc"
      env: CI_BUILD_TARGET="px4-v2 revo-bootloader"
    - compiler: "gcc"
      env: CI_BUILD_TARGET="px4-v4 revo-mini"
    - compiler: "gcc"
      env: CI_BUILD_TARGET="sitltest-copter"
    - compiler: "gcc"
      env: CI_BUILD_TARGET="sitltest-quadplane sitltest-plane sitltest-rover"

deploy:
  provider: releases
  api_key: "$GITHUB_DEPLOY_API_KEY"
  file_glob: true
  file: "$HOME/deploy_files/*"
  on:
    tags: true

